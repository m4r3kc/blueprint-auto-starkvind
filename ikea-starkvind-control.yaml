blueprint:
  name: Inteligentne sterowanie trybem oczyszczacza powietrza (wieloma)
  description: |
    <br>
    <b>ğŸ“˜Ten Blueprint steruje trybem pracy wielu oczyszczaczy powietrza na podstawie encji, przeÅ‚Ä…cznikÃ³w lub rÄ™cznych przeÅ‚Ä…cznikÃ³w na urzÄ…dzeniu. PrzeÅ‚Ä…cza oczyszczacz w tryb "auto" gdy poziom PM2.5 jest niski, a w tryb "rÄ™czny" z ustawionÄ… mocÄ…, gdy poziom PM2.5 jest wysoki. OpÃ³Åºnienie po wykonaniu akcji wynosi 3 minuty.</b>
    <br><br>
    ğŸ“… <b>PrzeÅ‚Ä…czniki, encje, obszary</b>: Oczyszczacze powietrza sÄ… sterowane trybem pracy przez przeÅ‚Ä…cznik, encjÄ™ lub obszar i automatycznie przeÅ‚Ä…czane w tryb "auto" po osiÄ…gniÄ™ciu ustawionego poziomu jakoÅ›ci powietrza.<br>
    â° <b>Automatyczne przeÅ‚Ä…czanie trybÃ³w</b>: Oczyszczacze powietrza sÄ… automatycznie przeÅ‚Ä…czane w tryb "auto" lub "rÄ™czny" w zaleÅ¼noÅ›ci od ustawionego poziomu jakoÅ›ci powietrza i rÄ™cznego uruchomienia na urzÄ…dzeniu.
  domain: automation
  input:
    manual_toggle:
      name: PrzeÅ‚Ä…cznik lub encja rÄ™cznego sterowania
      description: PrzeÅ‚Ä…cznik lub encja do rÄ™cznego uruchomienia trybu rÄ™cznego oczyszczacza powietrza (automatyczny powrÃ³t do trybu auto).
      selector:
        entity:
          domain:
            - input_boolean
            - switch
            - light
            - fan
            - binary_sensor
    manual_toggle_state:
      name: Stan przeÅ‚Ä…cznika lub encji rÄ™cznego sterowania
      description: Stan, w ktÃ³rym automatyzacja rÄ™cznego sterowania jest wyzwalana (wÅ‚Ä…czony lub wyÅ‚Ä…czony)
      default: "on"
      selector:
        select:
          options:
            - "on"
            - "off"
    pm2_5_sensor:
      name: Czujnik PM2.5
      description: Czujnik PM2.5 dla oczyszczaczy powietrza
      selector:
        entity:
          domain: sensor
    ppm_threshold:
      name: PrÃ³g PM2.5
      description: PrÃ³g (PPM) dla przeÅ‚Ä…czania oczyszczacza w tryb "auto"
      default: 50
      selector:
        number:
          min: 1
          max: 120
          step: 1
    fan_entities:
      name: Oczyszczacze powietrza
      description: Encje, obszary lub urzÄ…dzenia wybranych oczyszczaczy powietrza
      selector:
        target:
          entity:
            domain: fan
    manual_fan_speed_percentage:
      name: Procent mocy wentylatora w trybie rÄ™cznym
      description: Ustaw procent mocy wentylatora, gdy oczyszczacz przechodzi w tryb rÄ™czny (wartoÅ›Ä‡ 1-100)
      default: 70
      selector:
        number:
          min: 1
          max: 100
          step: 1
          unit_of_measurement: "%"

trigger:
  - platform: state
    entity_id: !input pm2_5_sensor
    id: auto_mode_control
  - platform: state
    entity_id: !input manual_toggle
    to: !input manual_toggle_state
    id: manual_mode_request

condition: []

action:
  - choose:
      # Automatyczne sterowanie trybem na podstawie PM2.5
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'auto_mode_control' }}"
        sequence:
          - delay:
              minutes: 3
          - condition: numeric_state
            entity_id: !input pm2_5_sensor
            below: !input ppm_threshold
          - service: fan.set_preset_mode
            target: !input fan_entities
            data:
              preset_mode: auto
      - conditions: # Zmieniamy 'default' na kolejny 'conditions'
          - condition: template
            value_template: "{{ trigger.id == 'auto_mode_control' }}"
          - condition: numeric_state
            entity_id: !input pm2_5_sensor
            above_equal: !input ppm_threshold # Warunek dla PM2.5 powyÅ¼ej lub rÃ³wnego progu
        sequence:
          - service: fan.set_preset_mode
            target: !input fan_entities
            data:
              preset_mode: none
          - service: fan.set_percentage
            target: !input fan_entities
            data:
              percentage: !input manual_fan_speed_percentage

      # RÄ™czne sterowanie - uruchomienie trybu rÄ™cznego
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'manual_mode_request' }}"
        sequence:
          - service: fan.set_preset_mode
            target: !input fan_entities
            data:
              preset_mode: none
          - service: fan.set_percentage
            target: !input fan_entities
            data:
              percentage: !input manual_fan_speed_percentage
          - delay:
              minutes: 3
          - condition: numeric_state
            entity_id: !input pm2_5_sensor
            below: !input ppm_threshold
          - service: fan.set_preset_mode
            target: !input fan_entities
            data:
              preset_mode: auto

mode: single
