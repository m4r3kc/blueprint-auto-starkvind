blueprint:
  name: Automatyczne sterowanie oczyszczaczem powietrza (wieloma)
  description: |
    <br>
    <b>📘Ten Blueprint włącza i automatycznie wyłącza wiele oczyszczaczy powietrza na podstawie encji, przełączników lub ręcznych przełączników na urządzeniu. Opóźnienie po wykonaniu akcji wynosi 3 minuty.</b>
    <br><br>
    📅 <b>Przełączniki, encje, obszary</b>: Oczyszczacze powietrza są włączane przez przełącznik, encję lub obszar i automatycznie wyłączane po osiągnięciu ustawionego poziomu jakości powietrza.<br>
    ⏰ <b>Automatyczne wyłączanie</b>: Oczyszczacze powietrza są automatycznie wyłączane po osiągnięciu ustawionego poziomu jakości powietrza i ręcznym uruchomieniu na urządzeniu.
  domain: automation
  input:
    manual_toggle:
      name: Przełącznik lub encja
      description: Przełącznik lub encja do ręcznego włączania oczyszczacza powietrza (wyłączanie automatyczne).
      selector:
        entity:
          domain:
            - input_boolean
            - switch
            - light
            - fan
            - binary_sensor
    manual_toggle_state:
      name: Stan przełącznika lub encji
      description: Stan, w którym automatyzacja jest wyzwalana (włączony lub wyłączony)
      default: "on"
      selector:
        select:
          options:
            - "on"
            - "off"
    pm2_5_sensor:
      name: Czujnik PM2.5
      description: Czujnik PM2.5 dla oczyszczaczy powietrza
      selector:
        entity:
          domain: sensor
    ppm_threshold:
      name: Próg PM2.5
      description: Próg (PPM) dla wyłączania oczyszczaczy powietrza
      default: 50
      selector:
        number:
          min: 1
          max: 120
          step: 1
    fan_entities:
      name: Oczyszczacze powietrza
      description: Encje, obszary lub urządzenia wybranych oczyszczaczy powietrza
      selector:
        target:
          entity:
            domain: fan

trigger:
  - platform: state
    entity_id: !input pm2_5_sensor
    id: autooff
  - platform: state
    entity_id: !input manual_toggle
    to: !input manual_toggle_state
    id: manual

condition: []

action:
  - choose:
      # Automatyczne sterowanie oparte na PM2.5
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'autooff' }}"
        sequence:
          - delay:
              minutes: 3  # Poczekaj 3 minuty, aby ustalić rzeczywistą wartość PM2.5
          - condition: numeric_state
            entity_id: !input pm2_5_sensor
            below: !input ppm_threshold  # Sprawdź, czy wartość PM2.5 jest poniżej progu
          - service: fan.turn_off
            target: !input fan_entities
      # Ręczne sterowanie
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'manual' }}"
        sequence:
          - service: fan.turn_on
            target: !input fan_entities
          - delay:
              minutes: 3  # Poczekaj 3 minuty, aby ustalić rzeczywistą wartość PM2.5
          - condition: numeric_state
            entity_id: !input pm2_5_sensor
            below: !input ppm_threshold  # Sprawdź, czy wartość PM2.5 jest poniżej progu
          - service: fan.turn_off
            target: !input fan_entities

mode: single
